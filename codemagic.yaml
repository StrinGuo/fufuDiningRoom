# Codemagic CI/CD è‡ªåŠ¨åŒ–æ„å»ºé…ç½®æ–‡ä»¶
# ç”¨äºé…ç½®è‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•å’Œå‘å¸ƒæµç¨‹

workflows:
  # iOS æ„å»ºå·¥ä½œæµ
  ios-workflow:
    name: iOS Workflow
    # æœ€å¤§æ„å»ºæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
    max_build_duration: 120
    # ä½¿ç”¨çš„æ„å»ºå®ä¾‹ç±»å‹
    instance_type: mac_mini_m1
    
    # ç¯å¢ƒé…ç½®
    environment:
      # ç¯å¢ƒå˜é‡
      vars:
        # Xcode å·¥ä½œç©ºé—´è·¯å¾„
        XCODE_WORKSPACE: "ios/Runner.xcworkspace"
        # Xcode æ„å»ºæ–¹æ¡ˆåç§°
        XCODE_SCHEME: "Runner"
        # Flutter SDK ç‰ˆæœ¬
        FLUTTER_VERSION: "3.35.7"
      
      # å·¥å…·ç‰ˆæœ¬é…ç½®
      flutter: stable
      xcode: latest
      cocoapods: default
    
    # æ„å»ºè„šæœ¬æ­¥éª¤
    scripts:
      # æ­¥éª¤1: è·å– Flutter ä¾èµ–åŒ…
      - name: Get Flutter dependencies
        script: |
          flutter pub get
      
      # æ­¥éª¤2: ç”Ÿæˆåº”ç”¨å›¾æ ‡
      - name: Generate app icons
        script: |
          flutter pub run flutter_launcher_icons
      
      # æ­¥éª¤3: æ¸…ç†å’Œé…ç½® CocoaPodsï¼ˆè§£å†³ CDN å’Œç¼“å­˜é—®é¢˜ï¼‰
      - name: Setup CocoaPods
        script: |
          # è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œç¦ç”¨ CDN
          export COCOAPODS_CDN_TRUNK_URL=""
          export COCOAPODS_DISABLE_STATS=1
          
          # æ¸…ç† CocoaPods ç¼“å­˜
          pod cache clean --all || true
          
          # Podfile ä¸­å·²é…ç½®ä½¿ç”¨ GitHub é•œåƒæºï¼Œæ— éœ€æ‰‹åŠ¨ç®¡ç†ä»“åº“
          # CocoaPods ä¼šè‡ªåŠ¨ä½¿ç”¨ Podfile ä¸­æŒ‡å®šçš„ source
          echo "âœ… CocoaPods ç¯å¢ƒé…ç½®å®Œæˆï¼ˆä½¿ç”¨ Podfile ä¸­çš„ GitHub é•œåƒæºï¼‰"
      
      # æ­¥éª¤4: å®‰è£… CocoaPods ä¾èµ–ï¼ˆiOS åŸç”Ÿä¾èµ–ç®¡ç†ï¼‰
      - name: Install CocoaPods dependencies
        script: |
          cd ios
          
          # åˆ é™¤æ—§çš„ Pods å’Œé”å®šæ–‡ä»¶
          rm -rf Pods Podfile.lock
          
          # è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œç¦ç”¨ CDN
          export COCOAPODS_DISABLE_STATS=1
          export COCOAPODS_CDN_TRUNK_URL=""
          
          # Podfile ä¸­å·²é…ç½® GitHub é•œåƒæºï¼Œç›´æ¥å®‰è£…å³å¯
          # CocoaPods ä¼šè‡ªåŠ¨ä½¿ç”¨ Podfile ä¸­æŒ‡å®šçš„ source
          echo "å¼€å§‹å®‰è£… CocoaPods ä¾èµ–ï¼ˆä½¿ç”¨ Podfile ä¸­çš„ GitHub é•œåƒæºï¼‰..."
          pod install || {
            echo "âŒ CocoaPods å®‰è£…å¤±è´¥"
            echo "æ£€æŸ¥ Podfile é…ç½®..."
            cat Podfile | grep -A 2 "source"
            exit 1
          }
          
          echo "âœ… CocoaPods ä¾èµ–å®‰è£…æˆåŠŸ"
          cd ..
      
      # æ­¥éª¤5: æ„å»º iOS
      # æ–¹æ¡ˆ1: ä¸ä½¿ç”¨ä»£ç ç­¾åï¼ˆå½“å‰ä½¿ç”¨ï¼Œé€‚ç”¨äºé€šè¿‡çˆ±æ€åŠ©æ‰‹ç­¾åå®‰è£…ï¼‰
      - name: Flutter build ios (no codesign)
        script: |
          # æ„å»º iOS åº”ç”¨ï¼Œä½†ä¸è¿›è¡Œä»£ç ç­¾å
          # é€‚ç”¨äºé€šè¿‡çˆ±æ€åŠ©æ‰‹ç­‰ç¬¬ä¸‰æ–¹å·¥å…·ç­¾åå®‰è£…çš„åœºæ™¯
          flutter build ios --release --no-codesign
          
          echo "âœ… iOS æ„å»ºå®Œæˆï¼ˆæœªç­¾åï¼‰"
          echo "ğŸ“¦ æ„å»ºäº§ç‰©ä½ç½®: build/ios/iphoneos/Runner.app"
          echo "ğŸ’¡ æç¤º: å¯ä»¥é€šè¿‡çˆ±æ€åŠ©æ‰‹å¯¹ .app æ–‡ä»¶è¿›è¡Œç­¾åå®‰è£…"
          
      # æ–¹æ¡ˆ2: ä½¿ç”¨ Codemagic è‡ªåŠ¨ä»£ç ç­¾åï¼ˆå¦‚æœæœ‰ Apple Developer è´¦å·ï¼‰
      # å¦‚éœ€ä½¿ç”¨è‡ªåŠ¨ç­¾åï¼Œè¯·ï¼š
      # 1. åœ¨ Codemagic UI ä¸­é…ç½® Apple Developer è´¦å·
      # 2. å–æ¶ˆä¸‹é¢æ³¨é‡Šï¼Œå¹¶æ³¨é‡Šæ‰ä¸Šé¢çš„æ–¹æ¡ˆ1
      # - name: Flutter build ipa (with codesign)
      #   script: |
      #     flutter build ipa --release
    
    # æ„å»ºäº§ç‰©ï¼ˆæ„å»ºå®Œæˆåä¿ç•™çš„æ–‡ä»¶ï¼‰
    artifacts:
      # iOS åº”ç”¨åŒ…ï¼ˆä½¿ç”¨ --no-codesign æ„å»ºï¼‰
      - build/ios/iphoneos/Runner.app
      # Xcode æ„å»ºæ—¥å¿—
      - /tmp/xcodebuild_logs/*.log
      # Flutter é©±åŠ¨æµ‹è¯•æ—¥å¿—
      - flutter_drive.log
    
    # å‘å¸ƒé…ç½®
    publishing:
      # é‚®ä»¶é€šçŸ¥é…ç½®
      email:
        recipients:
          # æ¥æ”¶é€šçŸ¥çš„é‚®ç®±åœ°å€
          - Stringuo@163.com
        notify:
          # æ„å»ºæˆåŠŸæ—¶å‘é€é‚®ä»¶
          success: true
          # æ„å»ºå¤±è´¥æ—¶ä¸å‘é€é‚®ä»¶
          failure: false
      
      # App Store Connect è‡ªåŠ¨ä¸Šä¼ é…ç½®ï¼ˆå½“å‰æœªå¯ç”¨ï¼‰
      app_store_connect:
        # å¦‚éœ€è‡ªåŠ¨ä¸Šä¼ åˆ° App Store Connectï¼Œå–æ¶ˆä»¥ä¸‹æ³¨é‡Šå¹¶é…ç½®
        # auth: integration
        # submit_to_testflight: false
        # beta_groups:
        #   - group name 1
        #   - group name 2
